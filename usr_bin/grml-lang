#!/bin/bash
# Filename:      grml-lang
# Purpose:       load specific keyboard layout settings
# Authors:       grml-team (grml.org), (c) Michael Prokop <mika@grml.org>
# Bug-Reports:   see http://grml.org/bugs/
# License:       This file is licensed under the GPL v2.
################################################################################

CONFFILE=/etc/default/keyboard
PN="$(basename "$0")"

usage(){
    echo "Usage: ${PN} <language>"
    echo "supported values: at, ch, de, dvorak, es, fr, it, jp, uk, us"
}

setvalue(){
  [ -n "$2" ] || return 1
  sudo sed -i "s#^${1}=.*#${1}=\"${2}\"#" "${CONFFILE}"
}

# Update keyboard configuration and apply changes
configure_keyboard(){
  local layout="$1"
  local variant="${2:-}"
  
  # Update /etc/default/keyboard
  if [ -r "$CONFFILE" ] ; then
    setvalue XKBLAYOUT "$layout"
    if [ -n "$variant" ] ; then
      setvalue XKBVARIANT "$variant"
    fi
  else
    # Create the file if it doesn't exist
    sudo tee "$CONFFILE" > /dev/null <<EOF
# Keyboard configuration for grml
XKBMODEL="pc105"
XKBLAYOUT="$layout"
EOF
    if [ -n "$variant" ] ; then
      echo "XKBVARIANT=\"$variant\"" | sudo tee -a "$CONFFILE" > /dev/null
    fi
  fi
  
  # Apply keyboard changes immediately
  sudo udevadm trigger --subsystem-match=input --action=change
  sudo /lib/console-setup/console-setup.sh
}

if [ $# -lt "1" ] ; then
   usage >&2
   exit 1
fi

LANGUAGE="$1"

# shellcheck disable=SC1091
. /etc/grml/language-functions

# Use proper keyboard configuration function
if [ -n "$XKEYBOARD" ] ; then
  # Determine variant based on language
  case "$LANGUAGE" in
    de|at)
      configure_keyboard "$XKEYBOARD" "nodeadkeys"
      ;;
    *)
      configure_keyboard "$XKEYBOARD"
      ;;
  esac
fi

# Check if we found a valid keyboard configuration
if [ -z "$XKEYBOARD" ] ; then
  echo "No valid parameter given."
  echo
  usage
  echo
  echo "Notice: grml-lang now configures keyboard layout via /etc/default/keyboard."
  echo "For locale settings, use grml-setlang."
  exit 1
else
  echo "Keyboard layout configured: $XKEYBOARD"
  [ -n "$2" ] && echo "Variant: $2"
  echo "Done."
fi

## END OF FILE #################################################################
